{% extends 'index.html' %}

{% block content %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    .payment-container {
        background: gray;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 20px;
        max-width: 600px;
        margin: 40px auto;
    }
    .header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .detail {
        margin-bottom: 10px;
        font-size: 16px;
    }
    .btn-confirm {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .btn-confirm:hover {
        background-color: #45a049;
    }
    /* Styling for the Stripe Elements */
    .StripeElement {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid transparent;
        border-radius: 4px;
        background-color: white;
        box-shadow: 0 1px 3px 0 #e6ebf1;
        transition: box-shadow 150ms ease;
    }
    .StripeElement--focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
    }
    .StripeElement--invalid {
        border-color: #fa755a;
    }
    .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
    }
</style>

<div class="payment-container">
    <div class="header">Finalize Your Payment</div>
    <div class="detail"><strong>Cinema Type:</strong> {{ cinema_type }}</div>
    <div class="detail"><strong>Movie Title:</strong> {{ movie_title }}</div>
    <div class="detail"><strong>Show:</strong> {{ show }}</div>
    <div class="detail"><strong>Movie Duration:</strong> {{ movie_duration }} minutes</div>
    <div class="detail"><strong>Total Price:</strong> ${{ total_price }}</div>
    <div class="detail"><strong>Selected Seats:</strong> 
        <div id="seat-list">
            {% for seat in selected_seats %}
            <span class="seat-label" data-id="{{ seat.id }}">{{ seat.seat_label }}</span>{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </div>
    </div>
    <!-- Stripe Elements will be inserted into this div -->
    <div id="card-element">
      <!-- A Stripe Element will be inserted here. -->
    </div>

    <!-- We'll put the error messages in this element -->
    <div id="card-errors" role="alert"></div>

    <button class="btn-confirm" id="submit-button">Confirm Payment</button>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
var stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');  // Use your Stripe public key
var elements = stripe.elements();

// Custom styling can be passed to options when creating an Element.
var style = {
  base: {
    color: "#32325d",
    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
    fontSmoothing: "antialiased",
    fontSize: "16px",
    "::placeholder": {
      color: "#aab7c4"
    }
  },
  invalid: {
    color: "#fa755a",
    iconColor: "#fa755a"
  }
};

// Create an instance of the card Element.
var card = elements.create('card', {style: style});

// Add an instance of the card Element into the `card-element` div.
card.mount('#card-element');

// Handle real-time validation errors from the card Element.
card.addEventListener('change', function(event) {
  var displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = '';
  }
});

// Handle form submission.
var form = document.getElementById('submit-button');
form.addEventListener('click', function(event) {
  event.preventDefault();

  fetch('/create_payment_intent/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({total_price: {{ total_price }}})
  })
  .then(function(result) {
    return result.json();
  })
  .then(function(data) {
    if (data.clientSecret) {
      stripe.confirmCardPayment(data.clientSecret, {
        payment_method: {
          card: card,
          billing_details: {
            name: '{{ user.username }}'  // Use dynamic username
          }
        }
      }).then(function(result) {
        if (result.error) {
          // Show error to your customer (e.g., insufficient funds)
          var displayError = document.getElementById('card-errors');
          displayError.textContent = result.error.message;
        } else {
          // The payment has been processed!
          if (result.paymentIntent.status === 'succeeded') {
            // Show a success message to your customer
            window.location.href = "/booking-success/";
          }
        }
      });
    } else {
      alert("Payment initiation failed: " + data.error);
    }
  }).catch(function(error) {
    console.error("Error:", error);
  });
});
</script>

{% endblock %}
